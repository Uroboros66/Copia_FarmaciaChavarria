name: VULN-001 - JWT hardcoded
on:
  push:
    paths: ['API_FarmaciaChavarria/**']
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build API
        run: |
          cd API_FarmaciaChavarria
          dotnet restore
          dotnet build -c Release

      - name: Run API
        run: |
          cd API_FarmaciaChavarria
          nohup dotnet run --urls "http://0.0.0.0:5000" > ../api.log 2>&1 &
          for i in {1..20}; do curl -sSf http://localhost:5000 && break || sleep 1; done

      - name: Login GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: ZAP baseline
        uses: zaproxy/action-baseline@v0.8.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target: 'http://localhost:5000'
          docker_name: 'ghcr.io/zaproxy/zap-stable'
          cmd_options: '-r zap_report_jwt.html'

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-jwt
          path: zap_report_jwt.html

      - name: Check hardcoded JWT
        run: |
          if grep -q 'MiClaveChavarriaSecretaFarmacia2022' API_FarmaciaChavarria/appsettings.json; then
            echo "::error ::VULN-001: Hardcoded JWT key detected"
            exit 1
          else
            echo "OK: No JWT hardcoded found (simple grep)."
          fi
