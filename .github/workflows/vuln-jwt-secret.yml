name: VULN-001 - JWT hardcoded (simple)

on:
  workflow_dispatch:
  push:
    paths: ['API_FarmaciaChavarria/**']

jobs:
  jwt-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Compilar API
        run: |
          cd API_FarmaciaChavarria
          dotnet restore
          dotnet build -c Release

      - name: üöÄ Ejecutar API
        run: |
          cd API_FarmaciaChavarria
          nohup dotnet run --urls "http://localhost:5000" > ../api.log 2>&1 &
          echo "Esperando que la API arranque..."
          sleep 15
          curl -sSf http://localhost:5000 || echo "‚ö†Ô∏è La API no respondi√≥, continuamos."

      - name: üîê Autenticarse en GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: üß™ Escaneo OWASP ZAP (b√°sico)
        run: |
          docker run --rm -v $(pwd):/zap/wrk -t ghcr.io/zaproxy/zap-stable \
            zap-baseline.py -t http://localhost:5000 -r zap_report_jwt.html || true

      - name: üì§ Subir reporte ZAP
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-jwt
          path: zap_report_jwt.html

      - name: üîç Buscar clave JWT hardcoded
        run: |
          if grep -q 'MiClaveChavarriaSecretaFarmacia2022' API_FarmaciaChavarria/appsettings.json; then
            echo "::error ::Hardcoded JWT key detected (VULN-001)"
            exit 1
          else
            echo "‚úÖ No se detect√≥ clave JWT hardcoded."
          fi
