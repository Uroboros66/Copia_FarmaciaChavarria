name: VULN-001 - Simple Security Scan
on:
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build and run API test
        run: |
          echo "ðŸ”§ Building and testing API..."
          cd API_FarmaciaChavarria
          
          # Verificar que el proyecto compile
          dotnet build
          
          # Intentar ejecutar la API brevemente
          timeout 10s dotnet run --urls="http://0.0.0.0:5000" || echo "API test completed"

      - name: Basic security checks
        run: |
          echo "ðŸ” Running basic security checks..."
          
          # Verificar archivos de configuraciÃ³n
          echo "=== Config Files Check ==="
          find . -name "appsettings*.json" -exec echo "Found: {}" \;
          
          # Buscar secrets hardcodeados
          echo "=== Secrets Check ==="
          if grep -r "Password" --include="*.json" . || \
             grep -r "Key" --include="*.json" . | grep -v '"Key": ""'; then
            echo "âš ï¸ Potential secrets found in config files"
          else
            echo "âœ… No obvious secrets found"
          fi
          
          # Verificar conexiones a BD
          echo "=== Database Connections Check ==="
          if grep -r "ConnectionString" --include="*.json" --include="*.cs" .; then
            echo "âš ï¸ Database connection strings found"
          else
            echo "âœ… No database connection strings found"
          fi

      - name: Generate security report
        run: |
          echo "ðŸ“‹ Generating security report..."
          cat > security-report.md << 'EOF'
          # Security Scan Report
          ## VULN-001 - JWT Security
          **Status**: Basic checks completed
          **API Test**: Build successful
          **Secrets Scan**: Configuration files reviewed
          **Next Steps**: Manual OWASP ZAP scan recommended
          
          ## Recommendations
          1. Configure GitHub Secrets for JWT keys
          2. Use environment variables for connection strings
          3. Implement input validation
          4. Add proper error handling
          EOF

      - name: Upload basic report
        uses: actions/upload-artifact@v4
        with:
          name: basic-security-scan
          path: |
            security-report.md
          retention-days: 30
