name: VULN-001 - Detect Hardcoded JWT Secret
on:
  workflow_dispatch:
  push:
    paths:
      - 'API_FarmaciaChavarria/appsettings.json'
      - 'API_FarmaciaChavarria/appsettings.*.json'
  pull_request:
    paths:
      - 'API_FarmaciaChavarria/appsettings.json'
      - 'API_FarmaciaChavarria/appsettings.*.json'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: VULN-001 - Scan for Hardcoded JWT Secrets
        id: jwt-scan
        run: |
          echo "üîç Starting VULN-001 Security Scan - Hardcoded JWT Secret Detection"
          echo "================================================================"
          
          # Variable para rastrear hallazgos
          FOUND_CRITICAL_ISSUES=false
          
          # 1. Detectar la clave espec√≠fica conocida
          echo "## 1. Scanning for known hardcoded JWT key..."
          if grep -r "MiClaveChavarriaSecretaFarmacia2022" . --include="*.json" --include="*.cs" --include="*.config"; then
            echo "‚ùå CRITICAL: Known JWT secret found in codebase"
            FOUND_CRITICAL_ISSUES=true
          fi
          
          # 2. Detectar estructura JWT en appsettings
          echo ""
          echo "## 2. Scanning for JWT configuration patterns..."
          JWT_FILES=$(find . -name "appsettings*.json" -exec grep -l "\"Jwt\"" {} \;)
          if [ -n "$JWT_FILES" ]; then
            echo "‚ö†Ô∏è  JWT configuration found in:"
            echo "$JWT_FILES"
            echo ""
            echo "üìÑ Content of JWT configurations:"
            find . -name "appsettings*.json" -exec grep -A 10 "\"Jwt\"" {} \;
            
            # Verificar si hay claves hardcodeadas
            if find . -name "appsettings*.json" -exec grep "\"Jwt\"" {} \; | grep -q "\"Key\""; then
              echo "‚ùå CRITICAL: JWT Key found in appsettings configuration"
              FOUND_CRITICAL_ISSUES=true
            fi
          fi
          
          # 3. Detectar cualquier clave que parezca secreta
          echo ""
          echo "## 3. Scanning for potential secrets..."
          SECRET_PATTERNS=(
            "[A-Za-z0-9]{32,}"
            "SecretKey"
            "Password"
            "ConnectionString"
            "Signature"
          )
          
          for pattern in "${SECRET_PATTERNS[@]}"; do
            echo "Checking pattern: $pattern"
            if find . -name "appsettings*.json" -exec grep -E "$pattern" {} \; | grep -v "//"; then
              echo "‚ö†Ô∏è  Potential secret pattern found: $pattern"
            fi
          done
          
          # 4. Reporte final
          echo ""
          echo "================================================================"
          echo "üìä VULN-001 SCAN SUMMARY"
          echo "================================================================"
          
          if [ "$FOUND_CRITICAL_ISSUES" = true ]; then
            echo "‚ùå SCAN FAILED: Critical security issues found"
            echo ""
            echo "üîí RECOMMENDED ACTIONS:"
            echo "   1. Remove hardcoded JWT secret from appsettings.json"
            echo "   2. Move secret to GitHub Secrets (JWT_KEY)"
            echo "   3. Update code to use: builder.Configuration[\"Jwt:Key\"]"
            echo "   4. Rotate the JWT key and revoke existing tokens"
            echo "   5. Add entropy validation for the new key"
            echo ""
            echo "üìö Reference: VULN-001 - Hardcoded JWT Secret"
            exit 1
          else
            echo "‚úÖ SCAN PASSED: No hardcoded JWT secrets detected"
            echo ""
            echo "üí° Security Best Practices:"
            echo "   - Always use environment variables for secrets"
            echo "   - Regularly rotate cryptographic keys"
            echo "   - Use Azure Key Vault or similar for production"
          fi

      - name: Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vuln-001-security-scan
          path: |
            API_FarmaciaChavarria/appsettings.json
            API_FarmaciaChavarria/appsettings.*.json
          retention-days: 30
