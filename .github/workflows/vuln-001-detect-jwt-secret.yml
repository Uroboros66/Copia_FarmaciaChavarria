name: VULN-001 - Hardcoded JWT Secret
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  scan-jwt-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for hardcoded JWT secrets
        run: |
          echo "üîç Scanning for hardcoded JWT secrets..."
          
          # Buscar espec√≠ficamente claves JWT con valores (no vac√≠as)
          FOUND_SECRETS=false
          
          # Buscar en appsettings.json
          if grep -q '"Key": "[^"]"' API_FarmaciaChavarria/appsettings.json; then
            echo "‚ùå VULN-001: Hardcoded JWT secret found in appsettings.json"
            grep '"Key": "[^"]"' API_FarmaciaChavarria/appsettings.json
            FOUND_SECRETS=true
          fi
          
          # Buscar en appsettings.Development.json
          if [ -f "API_FarmaciaChavarria/appsettings.Development.json" ] && grep -q '"Key": "[^"]"' API_FarmaciaChavarria/appsettings.Development.json; then
            echo "‚ùå VULN-001: Hardcoded JWT secret found in appsettings.Development.json"
            grep '"Key": "[^"]"' API_FarmaciaChavarria/appsettings.Development.json
            FOUND_SECRETS=true
          fi
          
          if [ "$FOUND_SECRETS" = true ]; then
            echo "üìã Evidencia: Claves JWT con valores encontradas"
            echo "üí° Recomendaci√≥n: Usar Azure Key Vault o GitHub Secrets"
            exit 1
          else
            echo "‚úÖ VULN-001: No hardcoded JWT secrets found (claves vac√≠as o usando env vars)"
          fi
