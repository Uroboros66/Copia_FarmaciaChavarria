name: VULN-001 - JWT Security Scan
on:
  workflow_dispatch:

jobs:
  zap-jwt-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build API
        run: dotnet build

      - name: Start API and wait for it
        run: |
          cd API_FarmaciaChavarria
          nohup dotnet run --urls="http://0.0.0.0:5000" > api.log 2>&1 &
          echo "ðŸ”„ Waiting for API to start..."
          
          # Esperar y verificar que la API estÃ© funcionando
          timeout 30 bash -c 'until curl -s http://localhost:5000 >/dev/null 2>&1; do 
            echo "Waiting for API..."; 
            sleep 2; 
          done' || echo "API might not be fully responsive"
          
          echo "âœ… API startup attempted"

      - name: Check API status
        run: |
          echo "ðŸ” Checking API status..."
          curl -s -o /dev/null -w "Status: %{http_code}\n" http://localhost:5000 || echo "Curl failed"
          netstat -tulpn | grep :5000 || echo "Port 5000 not found"
          ps aux | grep dotnet || echo "No dotnet processes found"

      - name: Run OWASP ZAP JWT Scan
        run: |
          echo "ðŸ” OWASP ZAP - Scanning for JWT vulnerabilities..."
          
          # Usar la IP del host en lugar de host.docker.internal
          docker run --add-host=host.docker.internal:host-gateway \
            -v $(pwd):/zap/wrk/:rw \
            -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t http://host.docker.internal:5000 \
            -J jwt-scan-report.json \
            -x jwt-report.xml \
            -d \
            --hook=/zap/hooks.py

      - name: Create simple ZAP hook for better handling
        run: |
          cat > hooks.py << 'EOF'
          def zap_started(zap, target):
              print("ZAP started successfully")
          
          def zap_pre_shutdown(zap):
              print("ZAP shutting down")
          EOF

      - name: Upload ZAP JWT Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-jwt-security-reports
          path: |
            jwt-scan-report.json
            jwt-report.xml
            API_FarmaciaChavarria/api.log
          retention-days: 30

      - name: Show API logs for debugging
        if: always()
        run: |
          echo "=== API Logs ==="
          cat API_FarmaciaChavarria/api.log || echo "No API log found"
          echo "=== Current Processes ==="
          ps aux | grep dotnet || echo "No dotnet processes"
