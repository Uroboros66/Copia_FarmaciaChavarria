name: VULN-001 - Endpoint Authentication Check
on:
  workflow_dispatch:

jobs:
  auth-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Check for unprotected endpoints
        run: |
          echo "ðŸ” Checking for unprotected endpoints..."
          
          # Buscar controllers sin atributos de autorizaciÃ³n
          echo "=== Controllers sin [Authorize] ==="
          if find . -name "*.cs" -type f | xargs grep -l "Controller" | xargs grep -L "Authorize" | grep -v "Test"; then
            echo "âš ï¸ Se encontraron controllers sin protecciÃ³n:"
            find . -name "*.cs" -type f | xargs grep -l "Controller" | xargs grep -L "Authorize" | grep -v "Test"
          else
            echo "âœ… Todos los controllers tienen atributo Authorize"
          fi
          
          # Verificar mÃ©todos pÃºblicos en controllers
          echo "=== MÃ©todos pÃºblicos en controllers ==="
          if find . -name "*.cs" -type f -path "*/Controllers/*" | xargs grep "public.*(" | grep -v "\[AllowAnonymous\]" | head -10; then
            echo "ðŸ“ Revisar estos mÃ©todos para autorizaciÃ³n"
          fi

      - name: Generate auth report
        run: |
          cat > vuln-001-report.md << 'EOF'
          # VULN-001 - Endpoint Authentication Report
          
          ## Hallazgos
          - VerificaciÃ³n de atributos [Authorize] en controllers
          - RevisiÃ³n de mÃ©todos pÃºblicos sin protecciÃ³n
          
          ## Recomendaciones
          1. Agregar [Authorize] a todos los controllers
          2. Usar [AllowAnonymous] solo donde sea estrictamente necesario
          3. Implementar JWT middleware global
          
          **Estado**: VerificaciÃ³n bÃ¡sica completada
          EOF

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: vuln-001-auth-check
          path: vuln-001-report.md
