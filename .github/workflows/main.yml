name: VULN-001 - Detect JWT hardcoded

on:
  push:
    paths:
      - 'API_FarmaciaChavarria/**'
  workflow_dispatch:

jobs:
  zap-jwt-scan:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Configurar .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: ‚öôÔ∏è Compilar y ejecutar API
        run: |
          cd API_FarmaciaChavarria
          dotnet restore
          dotnet build --no-restore -c Release
          nohup dotnet run --urls "http://0.0.0.0:5000" > ../api.log 2>&1 &
          echo "Esperando que la API est√© disponible..."
          for i in {1..30}; do
            if curl -sSf http://localhost:5000 >/dev/null 2>&1; then
              echo "‚úÖ API activa en localhost:5000"
              break
            fi
            sleep 2
          done

      - name: üß™ Ejecutar escaneo OWASP ZAP
        uses: zaproxy/action-baseline@v0.8.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target: 'http://localhost:5000'
          docker_name: 'ghcr.io/zaproxy/zap-stable'
          cmd_options: '-a -r zap_report_jwt.html'

      - name: üì§ Subir reporte de ZAP
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-jwt
          path: zap_report_jwt.html

      - name: üîç Buscar clave JWT hardcoded
        run: |
          echo "Buscando JWT hardcoded en appsettings.json..."
          if grep -q 'MiClaveChavarriaSecretaFarmacia2022' API_FarmaciaChavarria/appsettings.json; then
            echo "::error file=API_FarmaciaChavarria/appsettings.json,line=1::Hardcoded JWT key detected (VULN-001)"
            exit 1
          else
            echo "‚úÖ No se detectaron claves JWT hardcoded."
          fi
