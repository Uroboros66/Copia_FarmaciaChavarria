name: VULN-002 - Sensitive Data Exposure (Baseline)

on:
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Find and run project
        run: |
          CSPROJ=$(find . -name "*.csproj" | head -1)
          echo "Using project: $CSPROJ"
          dotnet build "$CSPROJ"
          nohup dotnet run --project "$CSPROJ" --urls=http://0.0.0.0:5006 &
          sleep 35
          curl -s http://localhost:5006/swagger/index.html && echo "✅ API Ready"

      - name: Run ZAP Baseline Scan (Docker)
        run: |
          docker run -v $(pwd):/zap/wrk/:rw -t ghcr.io/zaproxy/zaproxy:2.16.1 zap-baseline.py \
            -t http://host.docker.internal:5006 \
            -g gen.conf \
            -r zap-report.html \
            -J zap-report.json \
            -a

      - name: Check and handle results
        run: |
          if [ -f "zap-report.html" ]; then
            echo "✅ ZAP report generated successfully"
            ls -la zap-report.html
          else
            echo "⚠️ Creating fallback report"
            echo "<html><body><h1>ZAP Scan Completed</h1><p>Scan finished but no HTML report was generated. Check JSON report.</p></body></html>" > zap-report.html
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ZAP-Report-VULN-002
          path: zap-report.html
