name: VULN-002 - Sensitive Data Exposure (Simplified)

on:
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Find project file
        id: project
        run: |
          CSPROJ=$(find . -name "*.csproj" | head -1)
          if [ -z "$CSPROJ" ]; then
            echo "❌ No .csproj found"
            exit 1
          fi
          echo "project=$CSPROJ" >> $GITHUB_OUTPUT
          echo "✅ Found: $CSPROJ"

      - name: Build and run API
        run: |
          dotnet build "${{ steps.project.outputs.project }}"
          nohup dotnet run --project "${{ steps.project.outputs.project }}" --urls=http://0.0.0.0:5006 > api.log 2>&1 &
          sleep 30
          cat api.log

      - name: Test API endpoints
        run: |
          curl -s http://localhost:5006/swagger/index.html && echo "✅ Swagger OK" || echo "❌ Swagger failed"
          curl -s http://localhost:5006/swagger/v1/swagger.json > swagger.json && echo "✅ Swagger JSON OK" || echo "❌ Swagger JSON failed"

      - name: Run ZAP Quick Scan
        run: |
          wget -q https://github.com/zaproxy/zaproxy/releases/download/v2.16.1/ZAP_2.16.1_Linux.tar.gz
          tar -xvzf ZAP_2.16.1_Linux.tar.gz
          ./ZAP_2.16.1/zap.sh -cmd -quickurl http://localhost:5006 -quickout report.html -quickprogress

      - uses: actions/upload-artifact@v4
        with:
          name: ZAP-Report-VULN-002
          path: report.html
