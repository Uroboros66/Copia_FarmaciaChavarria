name: VULN-004 - Detect AllowedHosts wildcard
on:
  push:
    paths:
      - 'API_FarmaciaChavarria/**'
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Quick static check for AllowedHosts
        run: |
          if grep -R --line-number '"AllowedHosts"' API_FarmaciaChavarria/appsettings.json; then
              echo "AllowedHosts found"
          fi
          if grep -R '"AllowedHosts": "*" ' API_FarmaciaChavarria/appsettings.json; then
              echo "::error file=API_FarmaciaChavarria/appsettings.json::AllowedHosts set to '*' (VULN-004). Set explicit host names for production."
              exit 1
          else
              echo "AllowedHosts looks not wildcard or absent."
          fi

      - name: Optionally run ZAP baseline
        uses: zaproxy/action-baseline@v0.6.0
        with:
          target: 'http://localhost:5000'
          format: 'html'
          output: 'zap_report_allowedhosts.html'
          failOnRisk: 'false'

      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-allowedhosts
          path: zap_report_allowedhosts.html
